name: Auto Semantic Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze commits (Semantic Release Rules)
        id: commits
        run: |
          # ÎßàÏßÄÎßâ ÌÉúÍ∑∏ Ïù¥ÌõÑÏùò Ïª§Î∞ã Í∞ÄÏ†∏Ïò§Í∏∞
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "üìä No previous tag found, analyzing all commits"
            COMMITS=$(git log --pretty=format:"%B" --reverse)
          else
            echo "üìä Analyzing commits since $LAST_TAG"
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%B" --reverse)
          fi
          
          # Semantic Release Í∑úÏπôÏóê Îî∞Î•∏ Î≤ÑÏ†Ñ Í≤∞Ï†ï
          VERSION_TYPE="none"
          SHOULD_RELEASE="false"
          BREAKING_CHANGES="false"
          NEW_FEATURES="false"
          BUG_FIXES="false"
          
          # Í∞Å Ïª§Î∞ã Î∂ÑÏÑù
          while IFS= read -r commit; do
            # Skip empty lines
            [[ -z "$commit" ]] && continue
            
            # BREAKING CHANGE Ï≤¥ÌÅ¨ (Î≥∏Î¨∏Ïóê ÏûàÎäî Í≤ΩÏö∞)
            if echo "$commit" | grep -q "BREAKING CHANGE:" || echo "$commit" | grep -q "BREAKING-CHANGE:"; then
              BREAKING_CHANGES="true"
              SHOULD_RELEASE="true"
              echo "  üí• Breaking change detected"
            fi
            
            # Ï†úÎ™© ÎùºÏù∏Îßå Ï∂îÏ∂ú
            SUBJECT=$(echo "$commit" | head -n1)
            
            # feat! ÎòêÎäî fix! Í∞ôÏùÄ breaking change ÌëúÏãú
            if echo "$SUBJECT" | grep -qE "^[a-z]+(\(.*\))?!:"; then
              BREAKING_CHANGES="true"
              SHOULD_RELEASE="true"
              echo "  üí• Breaking change detected (! notation)"
            fi
            
            # feat: ÏÉà Í∏∞Îä•
            if echo "$SUBJECT" | grep -qE "^feat(\(.*\))?:"; then
              NEW_FEATURES="true"
              SHOULD_RELEASE="true"
              echo "  ‚ú® New feature detected"
            fi
            
            # fix: Î≤ÑÍ∑∏ ÏàòÏ†ï
            if echo "$SUBJECT" | grep -qE "^fix(\(.*\))?:"; then
              BUG_FIXES="true"
              SHOULD_RELEASE="true"
              echo "  üêõ Bug fix detected"
            fi
            
            # perf: ÏÑ±Îä• Í∞úÏÑ† (patch)
            if echo "$SUBJECT" | grep -qE "^perf(\(.*\))?:"; then
              BUG_FIXES="true"
              SHOULD_RELEASE="true"
              echo "  ‚ö° Performance improvement detected"
            fi
          done <<< "$COMMITS"
          
          # ÏµúÏ¢Ö Î≤ÑÏ†Ñ ÌÉÄÏûÖ Í≤∞Ï†ï (Ïö∞ÏÑ†ÏàúÏúÑ: major > minor > patch)
          if [ "$BREAKING_CHANGES" = "true" ]; then
            VERSION_TYPE="major"
            echo "üöÄ Version type: MAJOR (breaking changes)"
          elif [ "$NEW_FEATURES" = "true" ]; then
            VERSION_TYPE="minor"
            echo "üéâ Version type: MINOR (new features)"
          elif [ "$BUG_FIXES" = "true" ]; then
            VERSION_TYPE="patch"
            echo "üîß Version type: PATCH (bug fixes)"
          else
            echo "‚è≠Ô∏è  No release needed (only chore/docs/style/refactor/test commits)"
          fi
          
          echo "version_type=${VERSION_TYPE}" >> $GITHUB_OUTPUT
          echo "should_release=${SHOULD_RELEASE}" >> $GITHUB_OUTPUT

      - name: Configure Git
        if: steps.commits.outputs.should_release == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Login to Docker Hub
        if: steps.commits.outputs.should_release == 'true'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Execute release
        if: steps.commits.outputs.should_release == 'true'
        run: |
          make release-${{ steps.commits.outputs.version_type }}

      - name: Get version from file
        if: steps.commits.outputs.should_release == 'true'
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ Version: ${VERSION}"

      - name: Push changes
        if: steps.commits.outputs.should_release == 'true'
        run: |
          git push origin main
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Generate Release Notes
        if: steps.commits.outputs.should_release == 'true'
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          {
            echo "notes<<EOF"
            echo "## What's Changed in v${VERSION}"
            echo ""
            
            # Breaking Changes
            if git log ${LAST_TAG}..HEAD --grep="BREAKING" --pretty=format:"%s" | grep -q .; then
              echo "### üí• Breaking Changes"
              git log ${LAST_TAG}..HEAD --grep="BREAKING" --pretty=format:"- %s" 
              echo ""
            fi
            
            # New Features
            if git log ${LAST_TAG}..HEAD --grep="^feat" --pretty=format:"%s" | grep -q .; then
              echo "### ‚ú® Features"
              git log ${LAST_TAG}..HEAD --grep="^feat" --pretty=format:"- %s"
              echo ""
            fi
            
            # Bug Fixes
            if git log ${LAST_TAG}..HEAD --grep="^fix" --pretty=format:"%s" | grep -q .; then
              echo "### üêõ Bug Fixes"
              git log ${LAST_TAG}..HEAD --grep="^fix" --pretty=format:"- %s"
              echo ""
            fi
            
            # Performance
            if git log ${LAST_TAG}..HEAD --grep="^perf" --pretty=format:"%s" | grep -q .; then
              echo "### ‚ö° Performance"
              git log ${LAST_TAG}..HEAD --grep="^perf" --pretty=format:"- %s"
              echo ""
            fi
            
            echo "### üì¶ Docker"
            echo '```bash'
            echo "docker pull sanghaklee/ncc:${VERSION}"
            echo "docker pull sanghaklee/ncc:latest"
            echo '```'
            echo ""
            echo "**Full Changelog**: https://github.com/SangHakLee/ncc/compare/${LAST_TAG}...v${VERSION}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.commits.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
